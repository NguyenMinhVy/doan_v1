<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chi tiết Sự cố</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .container { margin-top: 20px; }
        .column {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .incident-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: none;
        }
        .card {
            margin-top: 15px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-good { background-color: #28a745; color: white; }
        .status-error { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <div th:if="${message}" class="alert alert-success" role="alert">
        <span th:text="${message}"></span>
    </div>

    <div class="row">
        <!-- Cột thông tin thiết bị/phần mềm -->
        <div class="col-md-4 column">
            <!-- Thông tin thiết bị -->
            <div th:if="${deviceDto != null}">
                <h3>Thông tin Thiết bị</h3>
                <!-- ... (giữ nguyên phần form thiết bị) ... -->
            </div>

            <!-- Thông tin phần mềm -->
            <div th:if="${softWareDto != null}">
                <h3>Thông tin Phần mềm</h3>
                <!-- ... (giữ nguyên phần form phần mềm) ... -->
            </div>
        </div>

        <!-- Cột thông tin sự cố -->
        <div class="col-md-8 column">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Thông tin Sự cố</h3>
                <button id="addIncidentBtn" class="btn btn-success">Thêm Sự cố</button>
            </div>

            <!-- Form thêm sự cố -->
            <div class="incident-form">
                <h4>Nhập thông tin sự cố</h4>
                <form id="incidentForm" th:action="@{/device/incident/add}" method="post">
                    <input type="hidden" name="deviceId" th:if="${deviceDto != null}" th:value="${deviceDto.id}"/>
                    <input type="hidden" name="softwareId" th:if="${softWareDto != null}" th:value="${softWareDto.id}"/>
                    
                    <div class="form-group">
                        <label for="description">Mô tả sự cố:</label>
                        <select id="description" name="description" class="form-control" required>
                            <option value="" disabled selected>Chọn một lỗi thường gặp</option>
                            <option value="Không khởi động được">Không khởi động được</option>
                            <option value="Màn hình xanh (BSOD)">Màn hình xanh (BSOD)</option>
                            <option value="Máy tính chạy chậm">Máy tính chạy chậm</option>
                            <option value="Không kết nối được mạng">Không kết nối được mạng</option>
                            <option value="Phần mềm không hoạt động">Phần mềm không hoạt động</option>
                            <option value="Máy tính tự khởi động lại">Máy tính tự khởi động lại</option>
                            <option value="Lỗi phần cứng">Lỗi phần cứng</option>
                            <option value="Lỗi phần mềm">Lỗi phần mềm</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Trạng thái:</label>
                        <select class="form-control" name="status" required>
                            <option value="2" selected>Lỗi</option>
                            <option value="1">Hoạt động</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ngày hoàn thành mong muốn:</label>
                        <input type="datetime-local" class="form-control" name="completionDate" required />
                    </div>

                    <!-- Hiển thị trường chọn kỹ thuật viên nếu người dùng là admin -->
                    <div class="form-group" th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
                        <label>Kỹ thuật viên phụ trách:</label>
                        <select class="form-control" name="technicianId">
                            <option value="">Chọn kỹ thuật viên</option>
                            <option th:each="technician : ${technicianList}"
                                    th:value="${technician.id}"
                                    th:text="${technician.userDto.name + ' (' + technician.technicianCode + ')'}">
                            </option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Thêm Sự cố</button>
                    <button type="button" class="btn btn-danger cancel-btn">Hủy</button>
                </form>
            </div>

            <!-- Danh sách sự cố -->
            <div th:if="${incidentDtoList == null || incidentDtoList.isEmpty()}" class="alert alert-info">
                <p class="text-center mb-0">Không có sự cố nào được ghi nhận.</p>
            </div>

            <div th:if="${incidentDtoList != null && !incidentDtoList.isEmpty()}" class="incident-list">
                <div th:each="incident : ${incidentDtoList}" class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title" th:text="${incident.description}"></h5>
                            <span th:class="${incident.status == 1 ? 'status-badge status-good' : 'status-badge status-error'}"
                                  th:text="${incident.status == 1 ? 'Hoạt động' : 'Lỗi'}">
                            </span>
                        </div>
                        <p class="card-text">
                            <strong>Ngày hoàn thành dự kiến:</strong>
                            <span th:text="${#temporals.format(incident.completionDate, 'dd/MM/yyyy HH:mm')}"></span>
                        </p>
                        <p class="card-text" th:if="${incident.technicianDto != null}">
                            <strong>Kỹ thuật viên phụ trách:</strong>
                            <span th:text="${incident.technicianDto.userDto.name + ' (' + incident.technicianDto.technicianCode + ')'}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Giữ nguyên phần JavaScript -->
<script>
    // ... (giữ nguyên phần JavaScript hiện có) ...
</script>

</body>
</html>
